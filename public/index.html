<style type="text/css">
    body,input,button {
        font-family: Lexend;
        word-spacing: -7px;
        font-size: 12px;
    }
    .flex-container {
        width: 100%
        border: 1px solid black;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }
    .game {
        width: 150px;
        height: 50px;
        border: 2px solid black;
        border-radius: 3px;
        padding: 3px;
    }
    .live {
        color: white;
        background-color: green;
    }
    .comming {
        color: black;
        background-color: lightblue;
        border-style: dotted;
    }
    .column {
        box-sizing: border-box;
      float: left;
      width: 50%;
      padding: 10px;
      height: 300px; /* Should be removed. Only for demonstration */
    }

    /* Clear floats after the columns */
    .row:after {
      content: "";
      display: table;
      clear: both;
    }
    .win {
        color: yellow;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>

<div ng-app="myApp" ng-controller="myCtrl">
    <div class="row" style="max-width: 900px;">
      <div class="column">
        {{invertory.values}}
        <canvas id="myChart"></canvas>
      </div>
      <div class="column">
        <div style="width: 100%:">
            <div style="width: 50%; float: left;">
                <canvas id="winrateChart"></canvas>
            </div>
            <div style="width: 50%; float: left;">
                <canvas id="typePressChart"></canvas>
            </div>
        </div>
      </div>
    </div>
    <div id="setting-play">
                
    </div>
    <div class="flex-container">
        <div ng-repeat="game in games.list">
            <div class="game"
                ng-class="game.remainTime < 0 ? 'live' : 'comming' ">
                <!-- 
                id:{{game.id}}
                {{game.league.name}}
                -->
            {{game.category.type}}-bo{{game.bo}}<br>
            <strong>{{game.vs1.name}}</strong>-{{game.offerMatch.vs1.odds}}<br>
            <strong>{{game.vs2.name}}</strong>-{{game.offerMatch.vs2.odds}}
            </div>
        </div>
    </div>
    <div class="flex-container">
        <div ng-repeat="game in gamesHistory.list">
            <div class="game"
                ng-class="game.remainTime < 0 ? 'live' : 'comming' ">
                <!-- 
                id:{{game.id}}
                {{game.league.name}}
                -->
            {{game.category.type}}-bo{{game.bo}}<br>
            <strong ng-class="game.offerMatch.win == 1 ? 'win' : '' ">{{game.vs1.name}}</strong>-{{game.offerMatch.vs1.odds}}<br>
            <strong ng-class="game.offerMatch.win == 2 ? 'win' : '' ">{{game.vs2.name}}</strong>-{{game.offerMatch.vs2.odds}}
            </div>
        </div>
    </div>
    <div style="width: 160px; height: 300px; position: fixed; bottom: 0; right: 0; border: 1px solid black; background-color: white;">
        SETTING<br>
        Type of game:<br>
        <input type="checkbox" id="game_lol" name="game_lol" value="game_lol">
        <label for="game_lol">LOL</label><br>
        <input type="checkbox" id="game_dota2" name="game_dota2" value="game_dota2">
        <label for="game_dota2">DOTA2</label><br>
        <input type="checkbox" id="game_csgo" name="game_csgo" value="game_csgo">
        <label for="game_csgo">CSGO</label><br>
        Prediction percent: <span id="winrate-content">{{predictionPer}}</span> % <br>
        <input type="range" min="1" max="100" ng-model="predictionPer">
        <br>

        <button onclick="runGame()">Apply</button><br>
        command: <input type="text" ng-model="command"><br>
        <button ng-click="send()">send message</button>
    </div>
</div>

<script>

var app = angular.module('myApp', []);
app.controller('myCtrl', function($scope, $interval) {
    $scope.firstName = "John";
    $scope.lastName = "Doe";
    $scope.invertory = {};
    $scope.games = {};
    $scope.gamesHistory = {};
    $scope.history = {};

    var ctx = document.getElementById('myChart').getContext('2d');
    var typePressChartx = document.getElementById('typePressChart').getContext('2d');
    var typePressChartObj = {
      type: 'doughnut',
      data: {
        labels:[],datasets:[{label:'Dataset 1',
        data:[],backgroundColor:dynamicColorArray(3)}]},
      options: {
        responsive:true,plugins:{legend: {position: 'top',},
        title:{display: false,text: 'Chart.js Pie Chart'}}}};
    var typePressChart = new Chart(typePressChartx, typePressChartObj);

    var winrateChartx = document.getElementById('winrateChart').getContext('2d');
    var winrateChartObj = {
      type: 'doughnut',
      data: {
        labels:['Win','Lose'],datasets:[{label:'Dataset 1',
        data:[3,6],backgroundColor:
        ['rgb(0,128,0)', 'rgb(28,28,28)']
    }]},
      options: {
        responsive:true,plugins:{legend: {position: 'top',},
        title:{display: false,text: 'Chart.js Pie Chart'}}}};
    var winrateChart = new Chart(winrateChartx, winrateChartObj);
    var chartObj = {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Value',
                    borderColor: 'rgb(0, 128, 0)',
                    backgroundColor: 'rgb(0, 128, 0, 0.5)',
                    fill: true,
                    data: []
                }
            ] 
        },
        options: {
            plugins: {
              title: {
                display: false,
                text: 'Chart Title',
              }
            }
        }
    };
    var chart = new Chart(ctx, chartObj);
    var wsUri = "ws://brain369.herokuapp.com:8888";
    var output;
    var websocket;

    initWebSocket();

    function initWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function(evt) {
            $scope.message = 'Kết nối với siêu não';
            $scope.sendCommand('HISTORY', {});
            $scope.sendCommand('GAME', {});
            $scope.sendCommand('GAME HISTORY', {});
            $scope.sendCommand('INVENTORY', {});
            $scope.$apply();
        };
        websocket.onclose = function(evt) {
        	location.reload();
        };
        websocket.onmessage = function(evt) {
            if (isJsonString(evt.data)) {
                var json = JSON.parse(evt.data);
                if (json.isClient) {
                    $scope.message = json;
                    if (json.command === "INVENTORY") {
                        $scope.invertory = json.data.datas;
                    }
                    if (json.command === "GAME") {
                        $scope.games = json.data.datas;
                    }
                    if (json.command === "GAME HISTORY") {
                        $scope.gamesHistory = json.data.datas;
                    }
                    if (json.command === "HISTORY") {
                        $scope.applyHistory(json);
                    }
                    $scope.$apply();
                }
            }
        };
        websocket.onerror = function(evt) { 
        	console.log(evt.data);
        	websocket.close();
        };
    }

    $scope.sendCommand = function(command, data) {
        var obj = {isClient:false,command:command,data:data};
        websocket.send(JSON.stringify(obj));
    }
    $scope.totalValue = 0;
    $scope.applyInventory = function(json) {
        $scope.invertory = json.data.datas;
        var total = $scope.invertory.user != null ? $scope.invertory.user.goldingot : 0;
        for (const i of $scope.invertory.list.length) {
            total += i.value;
        }
        $scope.totalValue = total;
    } 
    $scope.applyHistory = function(json) {
        $scope.history = json.data.datas;
        chartObj.data.labels = [];
        chartObj.data.datasets[0].data = [];
        typePressChartObj.data.labels = [];
        typePressChartObj.data.datasets[0].data = [];
        var array = $scope.history.list;
        var type = {};
        var win = 0;
        var lose = 0;
        var currentValue = $scope.invertory.values !== null ? $scope.invertory.values : 0;
        chartObj.data.labels.push(timeConverter(array[0].time/1000));
        chartObj.data.datasets[0].data.push(currentValue);
        for (var i = 0; i < array.length; i++) {
            if (type.hasOwnProperty(array[i].categoryicon)){
                type[array[i].categoryicon] += 1;
            }else{
                type[array[i].categoryicon] = 1;
            }
            if (array[i].value > 0) {
                win ++;
            }else{
                lose ++;
            }
            if ( i > 0 ) {
                chartObj.data.labels.push(timeConverter(array[i].time/1000));
                currentValue -= array[i-1].value;
                chartObj.data.datasets[0].data.push(currentValue);
            }
        }
        chartObj.data.labels.reverse();
        chartObj.data.datasets[0].data.reverse();
        for (const property in type) {
            typePressChartObj.data.labels.push(property);
            typePressChartObj.data.datasets[0].data.push(type[property]);
        }
        winrateChartObj.data.datasets[0].data = [win, lose];
        winrateChart.update();
        typePressChart.update();
        chart.update();
        // chart = new Chart(ctx, chartObj);
    }
    $scope.send = function() {
        var obj = {
            isClient: false,
            command: $scope.command,
            data: {}
        };
        websocket.send(JSON.stringify(obj));
    }
    var increaseCounter = function () {
        $scope.sendCommand('GAME', {});
    }
    var increaseCounter100 = function () {
        $scope.sendCommand('GAME HISTORY', {});
        $scope.sendCommand('HISTORY', {});
    }
    $interval(increaseCounter, 20000);
    $interval(increaseCounter100, 100000);
});

function isJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}
function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp * 1000);
  var months = ['1','2','3','4','5','6','7','8','9','10','11','12'];
  var year = a.getFullYear();
  var month = months[a.getMonth()];
  var date = a.getDate();
  var hour = a.getHours();
  var min = a.getMinutes();
  var sec = a.getSeconds();
  var time = date + '/' + month;
  return time;
}
var dynamicColorArray = function(size) {
    var i = 0;
    var array = [];
    while (i < size) {
        array.push(dynamicColors());
        i++;
    }
    return array;
}
var dynamicColors = function() {
    var r = Math.floor(Math.random() * 255);
    var g = Math.floor(Math.random() * 255);
    var b = Math.floor(Math.random() * 255);
    return "rgb(" + r + "," + g + "," + b + ")";
};
</script>